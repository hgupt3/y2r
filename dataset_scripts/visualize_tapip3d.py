"""
TAPIP3D Visualization Server

Serves the 3D visualization files generated by process_tapip3d.py.
The visualization files are already created during processing when vis_flag=True.

Usage:
    python visualize_tapip3d.py              # Serve visualizations
    python visualize_tapip3d.py --port 8080  # Use custom port
"""

import os
import sys
import yaml
import argparse
from pathlib import Path
from http.server import SimpleHTTPRequestHandler
from socketserver import ThreadingTCPServer

SCRIPT_DIR = Path(__file__).parent
DEFAULT_PORT = 8000


def load_config():
    """Load configuration from YAML file"""
    with open(SCRIPT_DIR / "config.yaml", 'r') as f:
        return yaml.safe_load(f)


def main():
    parser = argparse.ArgumentParser(description="Serve TAPIP3D 3D visualizations")
    parser.add_argument("--port", type=int, default=DEFAULT_PORT, help="Port to serve on")
    args = parser.parse_args()
    
    # Load config to find vis path
    config = load_config()
    vis_path = Path(config['tapip3d']['vis_path'])
    
    # Check if visualization exists
    if not vis_path.exists():
        print(f"Error: Visualization directory not found: {vis_path}")
        print(f"\nRun process_tapip3d.py first with vis_flag: true in config.yaml")
        sys.exit(1)
    
    # Check for index.html
    index_file = vis_path / "index.html"
    if not index_file.exists():
        print(f"Error: index.html not found in {vis_path}")
        print(f"\nRun process_tapip3d.py first with vis_flag: true in config.yaml")
        sys.exit(1)
    
    # Count available videos
    video_files = list(vis_path.glob("*_data.bin"))
    
    print(f"\nTAPIP3D Visualization Server")
    print(f"{'='*40}")
    print(f"Visualization path: {vis_path}")
    print(f"Videos available: {len(video_files)}")
    print(f"{'='*40}\n")
    
    # Change to vis directory and serve
    os.chdir(vis_path)
    
    host = "127.0.0.1"
    port = args.port
    
    httpd = ThreadingTCPServer((host, port), SimpleHTTPRequestHandler)
    
    print(f"Serving at: http://{host}:{port}/index.html")
    print(f"Press Ctrl+C to stop.\n")
    
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        print("\nServer stopped.")
        httpd.server_close()


if __name__ == "__main__":
    main()
